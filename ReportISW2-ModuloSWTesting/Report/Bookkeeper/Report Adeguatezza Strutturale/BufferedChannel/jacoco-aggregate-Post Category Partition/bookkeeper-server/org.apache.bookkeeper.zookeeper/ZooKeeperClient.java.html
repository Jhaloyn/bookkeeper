<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ZooKeeperClient.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Test-coverage</a> &gt; <a href="../index.html" class="el_bundle">bookkeeper-server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.zookeeper</a> &gt; <span class="el_source">ZooKeeperClient.java</span></div><h1>ZooKeeperClient.java</h1><pre class="source lang-java linenums">/**
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */
package org.apache.bookkeeper.zookeeper;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.util.concurrent.RateLimiter;
import com.google.common.util.concurrent.ThreadFactoryBuilder;
import java.io.IOException;
import java.util.List;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicReference;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.bookkeeper.stats.OpStatsLogger;
import org.apache.bookkeeper.stats.StatsLogger;
import org.apache.bookkeeper.zookeeper.ZooWorker.ZooCallable;
import org.apache.zookeeper.AsyncCallback.ACLCallback;
import org.apache.zookeeper.AsyncCallback.Children2Callback;
import org.apache.zookeeper.AsyncCallback.ChildrenCallback;
import org.apache.zookeeper.AsyncCallback.DataCallback;
import org.apache.zookeeper.AsyncCallback.MultiCallback;
import org.apache.zookeeper.AsyncCallback.StatCallback;
import org.apache.zookeeper.AsyncCallback.StringCallback;
import org.apache.zookeeper.AsyncCallback.VoidCallback;
import org.apache.zookeeper.CreateMode;
import org.apache.zookeeper.KeeperException;
import org.apache.zookeeper.Op;
import org.apache.zookeeper.OpResult;
import org.apache.zookeeper.Transaction;
import org.apache.zookeeper.WatchedEvent;
import org.apache.zookeeper.Watcher;
import org.apache.zookeeper.Watcher.Event.EventType;
import org.apache.zookeeper.Watcher.Event.KeeperState;
import org.apache.zookeeper.ZooKeeper;
import org.apache.zookeeper.data.ACL;
import org.apache.zookeeper.data.Stat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Provide a zookeeper client to handle session expire.
 */
public class ZooKeeperClient extends ZooKeeper implements Watcher, AutoCloseable {

<span class="nc" id="L72">    private static final Logger logger = LoggerFactory.getLogger(ZooKeeperClient.class);</span>

    private static final int DEFAULT_RETRY_EXECUTOR_THREAD_COUNT = 1;

    // ZooKeeper client connection variables
    private final String connectString;
    private final int sessionTimeoutMs;
    private final boolean allowReadOnlyMode;

    // state for the zookeeper client
<span class="nc" id="L82">    private final AtomicReference&lt;ZooKeeper&gt; zk = new AtomicReference&lt;ZooKeeper&gt;();</span>
<span class="nc" id="L83">    private final AtomicBoolean closed = new AtomicBoolean(false);</span>
    private final ZooKeeperWatcherBase watcherManager;

    private final ScheduledExecutorService retryExecutor;
    private final ExecutorService connectExecutor;

    // rate limiter
    private final RateLimiter rateLimiter;

    // retry polices
    private final RetryPolicy connectRetryPolicy;
    private final RetryPolicy operationRetryPolicy;

    // Stats Logger
    private final OpStatsLogger createStats;
    private final OpStatsLogger getStats;
    private final OpStatsLogger setStats;
    private final OpStatsLogger deleteStats;
    private final OpStatsLogger getChildrenStats;
    private final OpStatsLogger existsStats;
    private final OpStatsLogger multiStats;
    private final OpStatsLogger getACLStats;
    private final OpStatsLogger setACLStats;
    private final OpStatsLogger syncStats;
    private final OpStatsLogger createClientStats;

<span class="nc" id="L109">    private final Callable&lt;ZooKeeper&gt; clientCreator = new Callable&lt;ZooKeeper&gt;() {</span>

        @Override
        public ZooKeeper call() throws Exception {
            try {
<span class="nc" id="L114">                return ZooWorker.syncCallWithRetries(null, new ZooCallable&lt;ZooKeeper&gt;() {</span>

                    @Override
                    public ZooKeeper call() throws KeeperException, InterruptedException {
<span class="nc" id="L118">                        logger.info(&quot;Reconnecting zookeeper {}.&quot;, connectString);</span>
                        // close the previous one
<span class="nc" id="L120">                        closeZkHandle();</span>
                        ZooKeeper newZk;
                        try {
<span class="nc" id="L123">                            newZk = createZooKeeper();</span>
<span class="nc" id="L124">                        } catch (IOException ie) {</span>
<span class="nc" id="L125">                            logger.error(&quot;Failed to create zookeeper instance to &quot; + connectString, ie);</span>
<span class="nc" id="L126">                            throw KeeperException.create(KeeperException.Code.CONNECTIONLOSS);</span>
<span class="nc" id="L127">                        }</span>
<span class="nc" id="L128">                        waitForConnection();</span>
<span class="nc" id="L129">                        zk.set(newZk);</span>
<span class="nc" id="L130">                        logger.info(&quot;ZooKeeper session {} is created to {}.&quot;,</span>
<span class="nc" id="L131">                                Long.toHexString(newZk.getSessionId()), connectString);</span>
<span class="nc" id="L132">                        return newZk;</span>
                    }

                    @Override
                    public String toString() {
<span class="nc" id="L137">                        return String.format(&quot;ZooKeeper Client Creator (%s)&quot;, connectString);</span>
                    }

<span class="nc" id="L140">                }, connectRetryPolicy, rateLimiter, createClientStats);</span>
<span class="nc" id="L141">            } catch (Exception e) {</span>
<span class="nc" id="L142">                logger.error(&quot;Gave up reconnecting to ZooKeeper : &quot;, e);</span>
<span class="nc" id="L143">                Runtime.getRuntime().exit(-1);</span>
<span class="nc" id="L144">                return null;</span>
            }
        }

    };

    @VisibleForTesting
    static ZooKeeperClient createConnectedZooKeeperClient(
            String connectString, int sessionTimeoutMs, Set&lt;Watcher&gt; childWatchers,
            RetryPolicy operationRetryPolicy)
                    throws KeeperException, InterruptedException, IOException {
<span class="nc" id="L155">        return ZooKeeperClient.newBuilder()</span>
<span class="nc" id="L156">                .connectString(connectString)</span>
<span class="nc" id="L157">                .sessionTimeoutMs(sessionTimeoutMs)</span>
<span class="nc" id="L158">                .watchers(childWatchers)</span>
<span class="nc" id="L159">                .operationRetryPolicy(operationRetryPolicy)</span>
<span class="nc" id="L160">                .build();</span>
    }

    /**
     * A builder to build retryable zookeeper client.
     */
    public static class Builder {
<span class="nc" id="L167">        String connectString = null;</span>
<span class="nc" id="L168">        int sessionTimeoutMs = 10000;</span>
<span class="nc" id="L169">        Set&lt;Watcher&gt; watchers = null;</span>
<span class="nc" id="L170">        RetryPolicy connectRetryPolicy = null;</span>
<span class="nc" id="L171">        RetryPolicy operationRetryPolicy = null;</span>
<span class="nc" id="L172">        StatsLogger statsLogger = NullStatsLogger.INSTANCE;</span>
<span class="nc" id="L173">        int retryExecThreadCount = DEFAULT_RETRY_EXECUTOR_THREAD_COUNT;</span>
<span class="nc" id="L174">        double requestRateLimit = 0;</span>
<span class="nc" id="L175">        boolean allowReadOnlyMode = false;</span>

<span class="nc" id="L177">        private Builder() {}</span>

        public Builder connectString(String connectString) {
<span class="nc" id="L180">            this.connectString = connectString;</span>
<span class="nc" id="L181">            return this;</span>
        }

        public Builder sessionTimeoutMs(int sessionTimeoutMs) {
<span class="nc" id="L185">            this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="nc" id="L186">            return this;</span>
        }

        public Builder watchers(Set&lt;Watcher&gt; watchers) {
<span class="nc" id="L190">            this.watchers = watchers;</span>
<span class="nc" id="L191">            return this;</span>
        }

        public Builder connectRetryPolicy(RetryPolicy retryPolicy) {
<span class="nc" id="L195">            this.connectRetryPolicy = retryPolicy;</span>
<span class="nc" id="L196">            return this;</span>
        }

        public Builder operationRetryPolicy(RetryPolicy retryPolicy) {
<span class="nc" id="L200">            this.operationRetryPolicy = retryPolicy;</span>
<span class="nc" id="L201">            return this;</span>
        }

        public Builder statsLogger(StatsLogger statsLogger) {
<span class="nc" id="L205">            this.statsLogger = statsLogger;</span>
<span class="nc" id="L206">            return this;</span>
        }

        public Builder requestRateLimit(double requestRateLimit) {
<span class="nc" id="L210">            this.requestRateLimit = requestRateLimit;</span>
<span class="nc" id="L211">            return this;</span>
        }

        public Builder retryThreadCount(int numThreads) {
<span class="nc" id="L215">            this.retryExecThreadCount = numThreads;</span>
<span class="nc" id="L216">            return this;</span>
        }

        public Builder allowReadOnlyMode(boolean allowReadOnlyMode) {
<span class="nc" id="L220">            this.allowReadOnlyMode = allowReadOnlyMode;</span>
<span class="nc" id="L221">            return this;</span>
        }

        public ZooKeeperClient build() throws IOException, KeeperException, InterruptedException {
<span class="nc" id="L225">            checkNotNull(connectString);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            checkArgument(sessionTimeoutMs &gt; 0);</span>
<span class="nc" id="L227">            checkNotNull(statsLogger);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            checkArgument(retryExecThreadCount &gt; 0);</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (null == connectRetryPolicy) {</span>
<span class="nc" id="L231">                connectRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(sessionTimeoutMs, sessionTimeoutMs, Integer.MAX_VALUE);
            }
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (null == operationRetryPolicy) {</span>
<span class="nc" id="L235">                operationRetryPolicy =</span>
                        new BoundExponentialBackoffRetryPolicy(sessionTimeoutMs, sessionTimeoutMs, 0);
            }

            // Create a watcher manager
<span class="nc" id="L240">            StatsLogger watcherStatsLogger = statsLogger.scope(&quot;watcher&quot;);</span>
            ZooKeeperWatcherBase watcherManager =
<span class="nc bnc" id="L242" title="All 2 branches missed.">                    null == watchers ? new ZooKeeperWatcherBase(sessionTimeoutMs, watcherStatsLogger) :</span>
<span class="nc" id="L243">                            new ZooKeeperWatcherBase(sessionTimeoutMs, watchers, watcherStatsLogger);</span>
<span class="nc" id="L244">            ZooKeeperClient client = new ZooKeeperClient(</span>
                    connectString,
                    sessionTimeoutMs,
                    watcherManager,
                    connectRetryPolicy,
                    operationRetryPolicy,
                    statsLogger,
                    retryExecThreadCount,
                    requestRateLimit,
                    allowReadOnlyMode
            );
            // Wait for connection to be established.
            try {
<span class="nc" id="L257">                watcherManager.waitForConnection();</span>
<span class="nc" id="L258">            } catch (KeeperException ke) {</span>
<span class="nc" id="L259">                client.close();</span>
<span class="nc" id="L260">                throw ke;</span>
<span class="nc" id="L261">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L262">                Thread.currentThread().interrupt();</span>
<span class="nc" id="L263">                client.close();</span>
<span class="nc" id="L264">                throw ie;</span>
<span class="nc" id="L265">            }</span>
<span class="nc" id="L266">            return client;</span>
        }
    }

    public static Builder newBuilder() {
<span class="nc" id="L271">        return new Builder();</span>
    }

    protected ZooKeeperClient(String connectString,
                    int sessionTimeoutMs,
                    ZooKeeperWatcherBase watcherManager,
                    RetryPolicy connectRetryPolicy,
                    RetryPolicy operationRetryPolicy,
                    StatsLogger statsLogger,
                    int retryExecThreadCount,
                    double rate,
                    boolean allowReadOnlyMode) throws IOException {
<span class="nc" id="L283">        super(connectString, sessionTimeoutMs, watcherManager, allowReadOnlyMode);</span>
<span class="nc" id="L284">        this.connectString = connectString;</span>
<span class="nc" id="L285">        this.sessionTimeoutMs = sessionTimeoutMs;</span>
<span class="nc" id="L286">        this.allowReadOnlyMode =  allowReadOnlyMode;</span>
<span class="nc" id="L287">        this.watcherManager = watcherManager;</span>
<span class="nc" id="L288">        this.connectRetryPolicy = connectRetryPolicy;</span>
<span class="nc" id="L289">        this.operationRetryPolicy = operationRetryPolicy;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        this.rateLimiter = rate &gt; 0 ? RateLimiter.create(rate) : null;</span>
<span class="nc" id="L291">        this.retryExecutor =</span>
<span class="nc" id="L292">                Executors.newScheduledThreadPool(retryExecThreadCount,</span>
<span class="nc" id="L293">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-retry-executor-%d&quot;).build());</span>
<span class="nc" id="L294">        this.connectExecutor =</span>
<span class="nc" id="L295">                Executors.newSingleThreadExecutor(</span>
<span class="nc" id="L296">                    new ThreadFactoryBuilder().setNameFormat(&quot;ZKC-connect-executor-%d&quot;).build());</span>
        // added itself to the watcher
<span class="nc" id="L298">        watcherManager.addChildWatcher(this);</span>

        // Stats
<span class="nc" id="L301">        StatsLogger scopedStatsLogger = statsLogger.scope(&quot;zk&quot;);</span>
<span class="nc" id="L302">        createClientStats = scopedStatsLogger.getOpStatsLogger(&quot;create_client&quot;);</span>
<span class="nc" id="L303">        createStats = scopedStatsLogger.getOpStatsLogger(&quot;create&quot;);</span>
<span class="nc" id="L304">        getStats = scopedStatsLogger.getOpStatsLogger(&quot;get_data&quot;);</span>
<span class="nc" id="L305">        setStats = scopedStatsLogger.getOpStatsLogger(&quot;set_data&quot;);</span>
<span class="nc" id="L306">        deleteStats = scopedStatsLogger.getOpStatsLogger(&quot;delete&quot;);</span>
<span class="nc" id="L307">        getChildrenStats = scopedStatsLogger.getOpStatsLogger(&quot;get_children&quot;);</span>
<span class="nc" id="L308">        existsStats = scopedStatsLogger.getOpStatsLogger(&quot;exists&quot;);</span>
<span class="nc" id="L309">        multiStats = scopedStatsLogger.getOpStatsLogger(&quot;multi&quot;);</span>
<span class="nc" id="L310">        getACLStats = scopedStatsLogger.getOpStatsLogger(&quot;get_acl&quot;);</span>
<span class="nc" id="L311">        setACLStats = scopedStatsLogger.getOpStatsLogger(&quot;set_acl&quot;);</span>
<span class="nc" id="L312">        syncStats = scopedStatsLogger.getOpStatsLogger(&quot;sync&quot;);</span>
<span class="nc" id="L313">    }</span>

    @Override
    public void close() throws InterruptedException {
<span class="nc" id="L317">        closed.set(true);</span>
<span class="nc" id="L318">        connectExecutor.shutdown();</span>
<span class="nc" id="L319">        retryExecutor.shutdown();</span>
<span class="nc" id="L320">        closeZkHandle();</span>
<span class="nc" id="L321">    }</span>

    private void closeZkHandle() throws InterruptedException {
<span class="nc" id="L324">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L326">            super.close();</span>
        } else {
<span class="nc" id="L328">            zkHandle.close();</span>
        }
<span class="nc" id="L330">    }</span>

    public void waitForConnection() throws KeeperException, InterruptedException {
<span class="nc" id="L333">        watcherManager.waitForConnection();</span>
<span class="nc" id="L334">    }</span>

    protected ZooKeeper createZooKeeper() throws IOException {
<span class="nc" id="L337">        return new ZooKeeper(connectString, sessionTimeoutMs, watcherManager, allowReadOnlyMode);</span>
    }

    @Override
    public void process(WatchedEvent event) {
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (event.getType() == EventType.None</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            &amp;&amp; event.getState() == KeeperState.Expired) {</span>
<span class="nc" id="L344">            onExpired();</span>
        }
<span class="nc" id="L346">    }</span>

    private void onExpired() {
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (closed.get()) {</span>
            // we don't schedule any tries if the client is closed.
<span class="nc" id="L351">            return;</span>
        }

<span class="nc" id="L354">        logger.info(&quot;ZooKeeper session {} is expired from {}.&quot;,</span>
<span class="nc" id="L355">                Long.toHexString(getSessionId()), connectString);</span>
        try {
<span class="nc" id="L357">            connectExecutor.submit(clientCreator);</span>
<span class="nc" id="L358">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L360">                logger.error(&quot;ZooKeeper reconnect task is rejected : &quot;, ree);</span>
            }
<span class="nc" id="L362">        } catch (Exception t) {</span>
<span class="nc" id="L363">            logger.error(&quot;Failed to submit zookeeper reconnect task due to runtime exception : &quot;, t);</span>
<span class="nc" id="L364">        }</span>
<span class="nc" id="L365">    }</span>

    /**
     * A runnable that retries zookeeper operations.
     */
    abstract static class ZkRetryRunnable implements Runnable {

        final ZooWorker worker;
        final RateLimiter rateLimiter;
        final Runnable that;

        ZkRetryRunnable(RetryPolicy retryPolicy,
                        RateLimiter rateLimiter,
<span class="nc" id="L378">                        OpStatsLogger statsLogger) {</span>
<span class="nc" id="L379">            this.worker = new ZooWorker(retryPolicy, statsLogger);</span>
<span class="nc" id="L380">            this.rateLimiter = rateLimiter;</span>
<span class="nc" id="L381">            that = this;</span>
<span class="nc" id="L382">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (null != rateLimiter) {</span>
<span class="nc" id="L387">                rateLimiter.acquire();</span>
            }
<span class="nc" id="L389">            zkRun();</span>
<span class="nc" id="L390">        }</span>

        abstract void zkRun();
    }

    // inherits from ZooKeeper client for all operations

    @Override
    public long getSessionId() {
<span class="nc" id="L399">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L401">            return super.getSessionId();</span>
        }
<span class="nc" id="L403">        return zkHandle.getSessionId();</span>
    }

    @Override
    public byte[] getSessionPasswd() {
<span class="nc" id="L408">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L410">            return super.getSessionPasswd();</span>
        }
<span class="nc" id="L412">        return zkHandle.getSessionPasswd();</span>
    }

    @Override
    public int getSessionTimeout() {
<span class="nc" id="L417">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L419">            return super.getSessionTimeout();</span>
        }
<span class="nc" id="L421">        return zkHandle.getSessionTimeout();</span>
    }

    @Override
    public void addAuthInfo(String scheme, byte[] auth) {
<span class="nc" id="L426">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L428">            super.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L429">            return;</span>
        }
<span class="nc" id="L431">        zkHandle.addAuthInfo(scheme, auth);</span>
<span class="nc" id="L432">    }</span>

    private void backOffAndRetry(Runnable r, long nextRetryWaitTimeMs) {
        try {
<span class="nc" id="L436">            retryExecutor.schedule(r, nextRetryWaitTimeMs, TimeUnit.MILLISECONDS);</span>
<span class="nc" id="L437">        } catch (RejectedExecutionException ree) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (!closed.get()) {</span>
<span class="nc" id="L439">                logger.error(&quot;ZooKeeper Operation {} is rejected : &quot;, r, ree);</span>
            }
<span class="nc" id="L441">        }</span>
<span class="nc" id="L442">    }</span>

    private boolean allowRetry(ZooWorker worker, int rc) {
<span class="nc bnc" id="L445" title="All 4 branches missed.">        return worker.allowRetry(rc) &amp;&amp; !closed.get();</span>
    }

    @Override
    public synchronized void register(Watcher watcher) {
<span class="nc" id="L450">        watcherManager.addChildWatcher(watcher);</span>
<span class="nc" id="L451">    }</span>

    @Override
    public List&lt;OpResult&gt; multi(final Iterable&lt;Op&gt; ops) throws InterruptedException, KeeperException {
<span class="nc" id="L455">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;OpResult&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L459">                return &quot;multi&quot;;</span>
            }

            @Override
            public List&lt;OpResult&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L464">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L466">                    return ZooKeeperClient.super.multi(ops);</span>
                }
<span class="nc" id="L468">                return zkHandle.multi(ops);</span>
            }

        }, operationRetryPolicy, rateLimiter, multiStats);
    }

    @Override
    public void multi(final Iterable&lt;Op&gt; ops,
                      final MultiCallback cb,
                      final Object context) {
<span class="nc" id="L478">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L480">            final MultiCallback multiCb = new MultiCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;OpResult&gt; results) {
<span class="nc" id="L484">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L486">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L488">                        cb.processResult(rc, path, context, results);</span>
                    }
<span class="nc" id="L490">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L496">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L498">                    ZooKeeperClient.super.multi(ops, multiCb, worker);</span>
                } else {
<span class="nc" id="L500">                    zkHandle.multi(ops, multiCb, worker);</span>
                }
<span class="nc" id="L502">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L506">                return &quot;multi&quot;;</span>
            }
        };
        // execute it immediately
<span class="nc" id="L510">        proc.run();</span>
<span class="nc" id="L511">    }</span>

    @Override
    @Deprecated
    public Transaction transaction() {
        // since there is no reference about which client that the transaction could use
        // so just use ZooKeeper instance directly.
        // you'd better to use {@link #multi}.
<span class="nc" id="L519">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L521">            return super.transaction();</span>
        }
<span class="nc" id="L523">        return zkHandle.transaction();</span>
    }

    @Override
    public List&lt;ACL&gt; getACL(final String path, final Stat stat) throws KeeperException, InterruptedException {
<span class="nc" id="L528">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;ACL&gt;&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L532">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            public List&lt;ACL&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L537">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L539">                    return ZooKeeperClient.super.getACL(path, stat);</span>
                }
<span class="nc" id="L541">                return zkHandle.getACL(path, stat);</span>
            }

        }, operationRetryPolicy, rateLimiter, getACLStats);
    }

    @Override
    public void getACL(final String path, final Stat stat, final ACLCallback cb, final Object context) {
<span class="nc" id="L549">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getACLStats) {</span>

<span class="nc" id="L551">            final ACLCallback aclCb = new ACLCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, List&lt;ACL&gt; acl, Stat stat) {
<span class="nc" id="L555">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L557">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L559">                        cb.processResult(rc, path, context, acl, stat);</span>
                    }
<span class="nc" id="L561">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L567">                return String.format(&quot;getACL (%s, stat = %s)&quot;, path, stat);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L572">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L574">                    ZooKeeperClient.super.getACL(path, stat, aclCb, worker);</span>
                } else {
<span class="nc" id="L576">                    zkHandle.getACL(path, stat, aclCb, worker);</span>
                }
<span class="nc" id="L578">            }</span>
        };
        // execute it immediately
<span class="nc" id="L581">        proc.run();</span>
<span class="nc" id="L582">    }</span>

    @Override
    public Stat setACL(final String path, final List&lt;ACL&gt; acl, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L587">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public String toString() {
<span class="nc" id="L591">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L596">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L598">                    return ZooKeeperClient.super.setACL(path, acl, version);</span>
                }
<span class="nc" id="L600">                return zkHandle.setACL(path, acl, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setACLStats);
    }

    @Override
    public void setACL(final String path, final List&lt;ACL&gt; acl, final int version,
            final StatCallback cb, final Object context) {
<span class="nc" id="L609">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setACLStats) {</span>

<span class="nc" id="L611">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L615">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L617">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L619">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L621">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L627">                return String.format(&quot;setACL (%s, acl = %s, version = %d)&quot;, path, acl, version);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L632">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L634">                    ZooKeeperClient.super.setACL(path, acl, version, stCb, worker);</span>
                } else {
<span class="nc" id="L636">                    zkHandle.setACL(path, acl, version, stCb, worker);</span>
                }
<span class="nc" id="L638">            }</span>
        };
        // execute it immediately
<span class="nc" id="L641">        proc.run();</span>
<span class="nc" id="L642">    }</span>

    @Override
    public void sync(final String path, final VoidCallback cb, final Object context) {
<span class="nc" id="L646">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, syncStats) {</span>

<span class="nc" id="L648">            final VoidCallback vCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="nc" id="L652">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L654">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L656">                        cb.processResult(rc, path, context);</span>
                    }
<span class="nc" id="L658">                }</span>

            };

            @Override
            public String toString() {
<span class="nc" id="L664">                return String.format(&quot;sync (%s)&quot;, path);</span>
            }

            @Override
            void zkRun() {
<span class="nc" id="L669">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L671">                    ZooKeeperClient.super.sync(path, vCb, worker);</span>
                } else {
<span class="nc" id="L673">                    zkHandle.sync(path, vCb, worker);</span>
                }
<span class="nc" id="L675">            }</span>
        };
        // execute it immediately
<span class="nc" id="L678">        proc.run();</span>
<span class="nc" id="L679">    }</span>

    @Override
    public States getState() {
<span class="nc" id="L683">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L685">            return ZooKeeperClient.super.getState();</span>
        } else {
<span class="nc" id="L687">            return zkHandle.getState();</span>
        }
    }

    @Override
    public String toString() {
<span class="nc" id="L693">        ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (null == zkHandle) {</span>
<span class="nc" id="L695">            return ZooKeeperClient.super.toString();</span>
        } else {
<span class="nc" id="L697">            return zkHandle.toString();</span>
        }
    }

    @Override
    public String create(final String path, final byte[] data,
            final List&lt;ACL&gt; acl, final CreateMode createMode)
                    throws KeeperException, InterruptedException {
<span class="nc" id="L705">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;String&gt;() {</span>

            @Override
            public String call() throws KeeperException, InterruptedException {
<span class="nc" id="L709">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L711">                    return ZooKeeperClient.super.create(path, data, acl, createMode);</span>
                }
<span class="nc" id="L713">                return zkHandle.create(path, data, acl, createMode);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L718">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }

        }, operationRetryPolicy, rateLimiter, createStats);
    }

    @Override
    public void create(final String path, final byte[] data, final List&lt;ACL&gt; acl,
            final CreateMode createMode, final StringCallback cb, final Object context) {
<span class="nc" id="L727">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, createStats) {</span>

<span class="nc" id="L729">            final StringCallback createCb = new StringCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, String name) {
<span class="nc" id="L733">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L735">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L737">                        cb.processResult(rc, path, context, name);</span>
                    }
<span class="nc" id="L739">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L745">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L747">                    ZooKeeperClient.super.create(path, data, acl, createMode, createCb, worker);</span>
                } else {
<span class="nc" id="L749">                    zkHandle.create(path, data, acl, createMode, createCb, worker);</span>
                }
<span class="nc" id="L751">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L755">                return String.format(&quot;create (%s, acl = %s, mode = %s)&quot;, path, acl, createMode);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L759">        proc.run();</span>
<span class="nc" id="L760">    }</span>

    @Override
    public void delete(final String path, final int version) throws KeeperException, InterruptedException {
<span class="nc" id="L764">        ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Void&gt;() {</span>

            @Override
            public Void call() throws KeeperException, InterruptedException {
<span class="nc" id="L768">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L770">                    ZooKeeperClient.super.delete(path, version);</span>
                } else {
<span class="nc" id="L772">                    zkHandle.delete(path, version);</span>
                }
<span class="nc" id="L774">                return null;</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L779">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, deleteStats);
<span class="nc" id="L783">    }</span>

    @Override
    public void delete(final String path, final int version, final VoidCallback cb, final Object context) {
<span class="nc" id="L787">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, deleteStats) {</span>

<span class="nc" id="L789">            final VoidCallback deleteCb = new VoidCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx) {
<span class="nc" id="L793">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L795">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L797">                        cb.processResult(rc, path, context);</span>
                    }
<span class="nc" id="L799">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L805">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L807">                    ZooKeeperClient.super.delete(path, version, deleteCb, worker);</span>
                } else {
<span class="nc" id="L809">                    zkHandle.delete(path, version, deleteCb, worker);</span>
                }
<span class="nc" id="L811">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L815">                return String.format(&quot;delete (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L819">        proc.run();</span>
<span class="nc" id="L820">    }</span>

    @Override
    public Stat exists(final String path, final Watcher watcher) throws KeeperException, InterruptedException {
<span class="nc" id="L824">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L828">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L830">                    return ZooKeeperClient.super.exists(path, watcher);</span>
                }
<span class="nc" id="L832">                return zkHandle.exists(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L837">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public Stat exists(final String path, final boolean watch) throws KeeperException, InterruptedException {
<span class="nc" id="L845">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L849">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L851">                    return ZooKeeperClient.super.exists(path, watch);</span>
                }
<span class="nc" id="L853">                return zkHandle.exists(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L858">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, existsStats);
    }

    @Override
    public void exists(final String path, final Watcher watcher, final StatCallback cb, final Object context) {
<span class="nc" id="L866">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L868">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L872">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L874">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L876">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L878">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L884">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L886">                    ZooKeeperClient.super.exists(path, watcher, stCb, worker);</span>
                } else {
<span class="nc" id="L888">                    zkHandle.exists(path, watcher, stCb, worker);</span>
                }
<span class="nc" id="L890">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L894">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L898">        proc.run();</span>
<span class="nc" id="L899">    }</span>

    @Override
    public void exists(final String path, final boolean watch, final StatCallback cb, final Object context) {
<span class="nc" id="L903">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, existsStats) {</span>

<span class="nc" id="L905">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L909">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L911">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L913">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L915">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L921">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L923">                    ZooKeeperClient.super.exists(path, watch, stCb, worker);</span>
                } else {
<span class="nc" id="L925">                    zkHandle.exists(path, watch, stCb, worker);</span>
                }
<span class="nc" id="L927">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L931">                return String.format(&quot;exists (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L935">        proc.run();</span>
<span class="nc" id="L936">    }</span>

    @Override
    public byte[] getData(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L941">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="nc" id="L945">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L947">                    return ZooKeeperClient.super.getData(path, watcher, stat);</span>
                }
<span class="nc" id="L949">                return zkHandle.getData(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L954">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public byte[] getData(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L963">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;byte[]&gt;() {</span>

            @Override
            public byte[] call() throws KeeperException, InterruptedException {
<span class="nc" id="L967">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L969">                    return ZooKeeperClient.super.getData(path, watch, stat);</span>
                }
<span class="nc" id="L971">                return zkHandle.getData(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L976">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getStats);
    }

    @Override
    public void getData(final String path, final Watcher watcher, final DataCallback cb, final Object context) {
<span class="nc" id="L984">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L986">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L990">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L992">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L994">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L996">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1002">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1004">                    ZooKeeperClient.super.getData(path, watcher, dataCb, worker);</span>
                } else {
<span class="nc" id="L1006">                    zkHandle.getData(path, watcher, dataCb, worker);</span>
                }
<span class="nc" id="L1008">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1012">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1016">        proc.run();</span>
<span class="nc" id="L1017">    }</span>

    @Override
    public void getData(final String path, final boolean watch, final DataCallback cb, final Object context) {
<span class="nc" id="L1021">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getStats) {</span>

<span class="nc" id="L1023">            final DataCallback dataCb = new DataCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
<span class="nc" id="L1027">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1029">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1031">                        cb.processResult(rc, path, context, data, stat);</span>
                    }
<span class="nc" id="L1033">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1039">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1041">                    ZooKeeperClient.super.getData(path, watch, dataCb, worker);</span>
                } else {
<span class="nc" id="L1043">                    zkHandle.getData(path, watch, dataCb, worker);</span>
                }
<span class="nc" id="L1045">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1049">                return String.format(&quot;getData (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1053">        proc.run();</span>
<span class="nc" id="L1054">    }</span>

    @Override
    public Stat setData(final String path, final byte[] data, final int version)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1059">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;Stat&gt;() {</span>

            @Override
            public Stat call() throws KeeperException, InterruptedException {
<span class="nc" id="L1063">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1065">                    return ZooKeeperClient.super.setData(path, data, version);</span>
                }
<span class="nc" id="L1067">                return zkHandle.setData(path, data, version);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1072">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }

        }, operationRetryPolicy, rateLimiter, setStats);
    }

    @Override
    public void setData(final String path, final byte[] data, final int version,
            final StatCallback cb, final Object context) {
<span class="nc" id="L1081">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, setStats) {</span>

<span class="nc" id="L1083">            final StatCallback stCb = new StatCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx, Stat stat) {
<span class="nc" id="L1087">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1089">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1091">                        cb.processResult(rc, path, context, stat);</span>
                    }
<span class="nc" id="L1093">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1099">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1101">                    ZooKeeperClient.super.setData(path, data, version, stCb, worker);</span>
                } else {
<span class="nc" id="L1103">                    zkHandle.setData(path, data, version, stCb, worker);</span>
                }
<span class="nc" id="L1105">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1109">                return String.format(&quot;setData (%s, version = %d)&quot;, path, version);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1113">        proc.run();</span>
<span class="nc" id="L1114">    }</span>

    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1119">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1123">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1125">                    return ZooKeeperClient.super.getChildren(path, watcher, stat);</span>
                }
<span class="nc" id="L1127">                return zkHandle.getChildren(path, watcher, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1132">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch, final Stat stat)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1141">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1145">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1147">                    return ZooKeeperClient.super.getChildren(path, watch, stat);</span>
                }
<span class="nc" id="L1149">                return zkHandle.getChildren(path, watch, stat);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1154">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final Children2Callback cb, final Object context) {
<span class="nc" id="L1163">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1165">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="nc" id="L1170">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1172">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1174">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="nc" id="L1176">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1182">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1184">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1186">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="nc" id="L1188">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1192">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1196">        proc.run();</span>
<span class="nc" id="L1197">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch, final Children2Callback cb,
            final Object context) {
<span class="nc" id="L1202">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1204">            final Children2Callback childCb = new Children2Callback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children, Stat stat) {
<span class="nc" id="L1209">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1211">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1213">                        cb.processResult(rc, path, context, children, stat);</span>
                    }
<span class="nc" id="L1215">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1221">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1223">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1225">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="nc" id="L1227">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1231">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1235">        proc.run();</span>
<span class="nc" id="L1236">    }</span>


    @Override
    public List&lt;String&gt; getChildren(final String path, final Watcher watcher)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1242">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1246">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1248">                    return ZooKeeperClient.super.getChildren(path, watcher);</span>
                }
<span class="nc" id="L1250">                return zkHandle.getChildren(path, watcher);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1255">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public List&lt;String&gt; getChildren(final String path, final boolean watch)
            throws KeeperException, InterruptedException {
<span class="nc" id="L1264">        return ZooWorker.syncCallWithRetries(this, new ZooCallable&lt;List&lt;String&gt;&gt;() {</span>

            @Override
            public List&lt;String&gt; call() throws KeeperException, InterruptedException {
<span class="nc" id="L1268">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1270">                    return ZooKeeperClient.super.getChildren(path, watch);</span>
                }
<span class="nc" id="L1272">                return zkHandle.getChildren(path, watch);</span>
            }

            @Override
            public String toString() {
<span class="nc" id="L1277">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }

        }, operationRetryPolicy, rateLimiter, getChildrenStats);
    }

    @Override
    public void getChildren(final String path, final Watcher watcher,
            final ChildrenCallback cb, final Object context) {
<span class="nc" id="L1286">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1288">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="nc" id="L1293">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1295">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1297">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="nc" id="L1299">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1305">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1307">                    ZooKeeperClient.super.getChildren(path, watcher, childCb, worker);</span>
                } else {
<span class="nc" id="L1309">                    zkHandle.getChildren(path, watcher, childCb, worker);</span>
                }
<span class="nc" id="L1311">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1315">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watcher);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1319">        proc.run();</span>
<span class="nc" id="L1320">    }</span>

    @Override
    public void getChildren(final String path, final boolean watch,
            final ChildrenCallback cb, final Object context) {
<span class="nc" id="L1325">        final Runnable proc = new ZkRetryRunnable(operationRetryPolicy, rateLimiter, getChildrenStats) {</span>

<span class="nc" id="L1327">            final ChildrenCallback childCb = new ChildrenCallback() {</span>

                @Override
                public void processResult(int rc, String path, Object ctx,
                        List&lt;String&gt; children) {
<span class="nc" id="L1332">                    ZooWorker worker = (ZooWorker) ctx;</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">                    if (allowRetry(worker, rc)) {</span>
<span class="nc" id="L1334">                        backOffAndRetry(that, worker.nextRetryWaitTime());</span>
                    } else {
<span class="nc" id="L1336">                        cb.processResult(rc, path, context, children);</span>
                    }
<span class="nc" id="L1338">                }</span>

            };

            @Override
            void zkRun() {
<span class="nc" id="L1344">                ZooKeeper zkHandle = zk.get();</span>
<span class="nc bnc" id="L1345" title="All 2 branches missed.">                if (null == zkHandle) {</span>
<span class="nc" id="L1346">                    ZooKeeperClient.super.getChildren(path, watch, childCb, worker);</span>
                } else {
<span class="nc" id="L1348">                    zkHandle.getChildren(path, watch, childCb, worker);</span>
                }
<span class="nc" id="L1350">            }</span>

            @Override
            public String toString() {
<span class="nc" id="L1354">                return String.format(&quot;getChildren (%s, watcher = %s)&quot;, path, watch);</span>
            }
        };
        // execute it immediately
<span class="nc" id="L1358">        proc.run();</span>
<span class="nc" id="L1359">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>